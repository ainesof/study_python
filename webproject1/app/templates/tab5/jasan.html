<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title></title>
    {% extends 'base.html' %}
    {% block content %}

<style>
</style>
<script>

var readmode='';
var maxlength={{queryData1|length}};
var add_rows=0;
var date = new Date();
var month=(date.getMonth()+1)+'';
var day=(date.getDate())+'';
var today2=date.getFullYear()+"-"+month.padStart(2,'0')+"-"+day.padStart(2,'0');
var modi_str=[]; <!-- 수정 내역들 -->
var td_str=[];  <!-- 클릭비교용 -->

$(function () {



    readmode='{{readmode}}';
    $('#undo_exc').hide();
    $('#ins_exc').hide();


    <!-- 메뉴 링크 -->
    $('button[name^=submenu]').click(function(){
        var menu=$(this).attr('name')
        if(menu=='submenu1'){  window.open("/jasan/0", "_self");   }
        else if(menu=='submenu2'){ window.open("/jasan/1", "_self");  }
        else if(menu=='submenu3'){ window.open("/jasan/2", "_self");  }
        else if(menu=='submenu4'){ window.open("/jasan/3", "_self");  }
        else if(menu=='submenu5'){ window.open("/jasan/4", "_self");  }
        else if(menu=='submenu6'){ window.open("/rental_pdf", "_blank");  }
    });

    <!-- 항목 선택 -->
    $(document).on("click","[name=tbody_input]",function(){
        $(this).select();
    });

    <!-- 수정값 저장 -->
    $(document).on("click","[name=tbody_input]",function(){
        if('{{gubun}}'==2){
            var td=$(this).parent().parent().children();
            var col=$(this).closest('td').prevAll().length;
            td_str[0]=td.eq(2).children().val();
            td_str[1]=td.eq(3).children().val();
        }

    });

    $(document).on("blur","[name=tbody_input]",function(){
        if('{{gubun}}'==2){
            var td=$(this).parent().parent().children();
            var col=$(this).closest('td').prevAll().length;
<!--            var row=$(this).closest('tr').prevAll().length;-->
            var click_col=td.eq(col).children().val().toUpperCase();
            var ret='';

            if(col==2 && click_col=='X'){
                td.eq(col).children().val('X');
                ret=td.eq(col+1).children().val(); <!-- 반납값 -->
                td.eq(col+1).children().val('nan');
                modi_save(td,ret);
            }
            else if(col==2 && click_col!='X'){
                td.eq(col).children().val('0');
                td.eq(col+1).children().select();
            }
            if(col==3){
                modi_save(td,ret);
            }
        }
    });


});

function modi_save(td,ret){
<!-- 수정값 리스트 추가. 변경해서 원상복귀한건 값이 추가됨 -->
    var imsi_str=[];
    if((td_str[0]!=td.eq(2).children().val()) || (td_str[0]=='0' && td_str[1]!=td.eq(3).children().val())){
        imsi_str.push(td.eq(0).children().val());
        imsi_str.push(td.eq(1).children().val());
        if(td.eq(2).children().val()=='X'){
        imsi_str.push('X');
        imsi_str.push(ret);
        }
        else if(td.eq(2).children().val()=='0'){
        imsi_str.push('0');
        imsi_str.push(td.eq(3).children().val());
        }
    }

<!-- imsi_str와 modi_str 비교해서 최신값 갱신 -->

    for(var i=0;i<modi_str.length;i+=4){
        if(imsi_str[1]==modi_str[i+1]){
            modi_str.splice(i,4);
        }
    }
    modi_str.push(...imsi_str);
<!--    alert(modi_str);-->
}

function modify(){
    <!-- 수정모드 -->
    var index_loc='';

    if(readmode=='y'){
        $.ajax({
            url : {{ url_for('tab5.jasan_modi')}}
            ,type: 'post'
            ,dataType: 'JSON'
            ,traditional : true
            ,data: {'readmode': readmode}
        })
        .done(function(value){
            readmode=value;
            var context="";
            $('[name="toExcel"]').hide();
            $('#undo_exc').show();
            $('#ins_exc').show();
            $('#modi_exc').val("저장");

            context+='<table class="table table-striped table-bordered table-hover" id="tab5_table">';
            context+='<thead>';
            context+='<tr name="thead_tr" class="thead-dark">';
            {% for i in range(header|length) %}
                {% if index[gubun]==header[i] %}
                    index_loc={{i}};
                {% endif %}
                context+='<th style="font-size:10pt;">{{header[i]}}</th>';
            {% endfor %}
            context+='</tr></thead>';
            context+='<tbody id="tbody">';
            {% for i in range(queryData1|length) %}
                context+='<tr>';
                {% for j in range(header|length) %}
                    context+='<td style="font-size:10pt;';
                    if({{j}}==index_loc){
                    context+='background-color:#DDDDDD;';
                    }
                    context+='">';
                    context+='<input name="tbody_input" type="text" style="width:100%; border:none; background:transparent;" value={{queryData1[i][j]}}';
                    {% if gubun==0 and j==0 %}
                        context+=' disabled ';
                    {% endif %}
                    context+='></td>';
                {% endfor %}
                context+='</tr>';
            {% endfor %}
            context+='</tbody></table>';

            $('#table_readmode').empty();
            $('#table_readmode').html(context);
            $('[name="thead_tr"]').attr('align','center');

        });
    }
    <!-- 저장 -->
    else if(readmode=='n'){
        var dataset=[];
        var header=[];
        var etc_dataset=[];
        var etc_header=[];
        var value='';
        var maxCell={{(header|length)}}*{{(queryData1|length)}};
        var td=$('#tbody').children().children();
        var index=[];
        var gubun={{gubun}};
        var rows={{(queryData1|length)}};
        var etc_rows={{(etc_dataset|length)}};

        {% for i in range(index|length) %}
            index.push('{{index[i]}}');
        {% endfor %}

        {% for i in range(header|length) %}
            header.push('{{header[i]}}');
        {% endfor %}

        {% for i in range(etc_header|length) %}
            etc_header.push('{{etc_header[i]}}');
        {% endfor %}

        for(var i=0;i<maxCell;i++){
            value=td.eq(i).children().val();
            dataset.push(value);
        }
        <!-- 추가내용 삽입 -->
        if($('[name="app_tr"]').length>0){
            for(j=0;j<add_rows;j++){
                var td=$('[name="app_tr"]').eq(j).children();
                for(var i=0;i<header.length;i++){
                    value=td.eq(i).children().val();
                    dataset.push(value);
                }
                rows++;
            }
        }

        {% for i in range(etc_dataset|length) %}
            {% for j in range(etc_header|length) %}
                etc_dataset.push('{{etc_dataset[i][j]}}');
            {% endfor %}
        {% endfor %}

        <!-- 수정이력 기록 -->
        if(modi_str.length>0){
            for(var i=0;i<modi_str.length;i+=4){
                etc_dataset.push(modi_str[i+1]);
                if(modi_str[2]=='0'){
                    etc_dataset.push(today2)
                    etc_dataset.push(modi_str[i+3]);
                    etc_dataset.push('nan');
                    etc_dataset.push('nan');
                }
                else if(modi_str[2]=='X'){
                    etc_dataset.push('nan');
                    etc_dataset.push('nan');
                    etc_dataset.push(today2)
                    etc_dataset.push(modi_str[i+3]);
                }
                etc_rows++;
           }
        }

        if(gubun==0){
            sheet1={    dataset: dataset, header:header, rows:rows   };
            sheet2={    dataset: etc_dataset, header:etc_header, rows:etc_rows    };
        }
        else if(gubun==1){
            sheet1={    dataset: etc_dataset, header:etc_header, rows:etc_rows    };
            sheet2={    dataset: dataset, header:header, rows:rows   };
        }
        else if(gubun==2){
            sheet1={    dataset: dataset, header:header, rows:rows   };
            sheet2={    dataset: etc_dataset, header:etc_header, rows:etc_rows    };
        }
        else if(gubun==3){
            sheet1={    dataset: etc_dataset, header:etc_header, rows:etc_rows    };
            sheet2={    dataset: dataset, header:header, rows:rows   };
        }
        else if(gubun==4){
            sheet1={    dataset: dataset, header:header, rows:rows    };
        }
        if(gubun in [0,1,2,3]){
            $.ajax({
                url : {{ url_for('tab5.jasan_modi')}}
                ,type: 'post'
                ,dataType: 'JSON'
                ,traditional : true
                ,data: {readmode : readmode, filename: '{{filename}}', index : JSON.stringify(index), gubun : '{{gubun}}',
                sheet1: JSON.stringify(sheet1), sheet2: JSON.stringify(sheet2)}
            })
            .done(function(value){
                history.go(0);
            });
        }
        else if(gubun == 4){
             $.ajax({
                url : {{ url_for('tab5.jasan_modi')}}
                ,type: 'post'
                ,dataType: 'JSON'
                ,traditional : true
                ,data: {readmode : readmode, filename: '{{filename}}', index : JSON.stringify(index), gubun : '{{gubun}}',
                sheet1: JSON.stringify(sheet1)}
            })
            .done(function(value){
                history.go(0);
            });
        }
    }
}

<!-- 1줄 추가 -->
function append(){
    var context='';

    context+='<table class="table table-striped table-bordered table-hover"><tr name="app_tr">';
    context+='<td style="font-size:10pt;"><input type="text" style="width:100%; border:none; background:transparent;" ';
    {% if gubun==0 %}
        context+='value='+maxlength;
        context+=' disabled></td>';
    {% else %}
        context+='></td>';
    {% endif %}
    {% for j in range(header|length-1) %}
        context+='<td style="font-size:10pt;">';
        context+='<input type="text" style="width:100%; border:none; background:transparent;"';
        {% if gubun==0 and j==1 %}
            context+=' value="'+today2;
            context+='"';
        {% endif %}
        context+='>';
        context+='</td>';
    {% endfor %}
    context+='</tr></table>';
    $('#table_append').append(context);
    maxlength+=1;
    add_rows++;
}

    <!-- 수정취소 -->
function cancel(){
    history.go(0);
}

</script>
</head>
<body>
<div class="container my-3">
    <table>
        <tr>
            <p class="text-center" style="font-size:20pt;"><b name="headtitle">{{headtitle}}</b></p>
        </tr>
        <div class="container my-3"><tr><td colspan="3">
            <div class="btn-group btn-group-sm" role="group" aria-label="...">
                <button type="button" name="submenu1" class="btn btn-outline-secondary">{{title[0]}}</button>
                <button type="button" name="submenu2" class="btn btn-outline-secondary">{{title[1]}}</button>
                <button type="button" name="submenu3" class="btn btn-outline-secondary">{{title[2]}}</button>
                <button type="button" name="submenu4" class="btn btn-outline-secondary">{{title[3]}}</button>
                <button type="button" name="submenu5" class="btn btn-outline-secondary">{{title[4]}}</button>
                <button type="button" name="submenu6" class="btn btn-outline-secondary">{{title[5]}}</button>
            </div>
        </td></tr></div>
        <tr style="height:20px"></tr>
        {% if gubun==0 or gubun==1 %}
        <tr><td>남은 임시카드: {{remaincard}}</td></tr>
        <tr><td>대여중: {{usecardlist}}</td></tr>
        {% endif %}
        <tr>
            <div><td align="right">
                <input class="btn btn-dark" type="button" name="toExcel" value="excel"/>
                <input id="ins_exc" class="btn btn-dark" type="button" onclick="append()" value="추가">
                <input id="modi_exc" class="btn btn-dark" type="button" onclick="modify()" value="수정" style="display:inline"/>
                <input id="undo_exc" class="btn btn-dark" type="button" onclick="cancel()" value="취소">
            </td></div>
        </tr>
    </table>
</div>
<div id="table_append" class="container my-3"></div>
<div id="table_readmode" class="container my-3">
    <table class="table table-striped table-bordered table-hover" id="tab5_table" style="">
        <thead>
            <tr class="thead-dark" align="center">
                {% for i in range(header|length) %}
                <th style="font-size:10pt;">{{header[i]}}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody align="center">
            {% for i in range(queryData1|length) %}
            <tr>
                {% for j in range(header|length) %}
                    <td style="font-size:10pt;">
                        {% if j==0 and gubun==0 %}
                            {{ i }}
                        {% else %}
                            {{queryData1[i][j]}}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<input type="hidden" name="win" value="{{win}}"/>
<input type="hidden" name="logic" value="{{logic}}"/>
{% endblock %}

</body>
</html>